<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <link rel="icon" href="apple-touch-icon.png" type="image/png">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <title>Control de Empleados</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
      body {
          background-image: url('fondobrimez.jpeg');
          background-size: cover;
          background-position: center;
          background-repeat: no-repeat;
          margin: 0;
          padding: 0;
          font-family: Arial, sans-serif;
          height: 100vh;
          width: 100%;
          display: flex;
          flex-direction: column;
          overflow: hidden;
      }
      
      h1 {
          margin: 10px 0 5px;
          font-size: 1.8rem;
      }
      
      #clock {
          margin: 0 0 5px;
          font-size: 1.2rem;
      }
      
      .contenedor {
          display: flex;
          flex-direction: column;
          gap: 10px;
          margin-top: 5px;
          align-items: center;
          flex: 1;
          overflow: hidden;
          max-height: calc(100vh - 100px);
      }
      
      .card, .registro {
          background-color: rgba(255, 255, 255, 0.8);
          padding: 15px;
          border-radius: 8px;
          width: 90%;
          max-width: 1200px;
      }
      
      .card {
          flex-shrink: 0;
      }
      
      .registro {
          flex: 1;
          overflow-y: auto;
          max-height: calc(100vh - 300px);
      }
      
      /* Estilos para los campos de texto */
      #employeeId, #employeeName {
          width: 70%;
          margin: 3px auto;
          padding: 6px;
          border-radius: 4px;
          border: 1px solid #ced4da;
          display: block;
      }
      
      /* Estilos para las etiquetas */
      label {
          display: block;
          margin-top: 5px;
          text-align: center;
          font-size: 0.9rem;
      }
      
      /* Estilos para los botones */
      .buttons {
          display: flex;
          justify-content: center;
          gap: 10px;
          margin-top: 10px;
      }
      
      .entrada, .salida {
          padding: 6px 12px;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-weight: bold;
          font-size: 0.9rem;
      }
      
      /* Contenedor de botones de navegaci√≥n */
      .nav-buttons {
          display: flex;
          justify-content: center;
          padding: 5px 0;
          flex-shrink: 0;
      }
      
      .link-button {
          display: inline-block;
          padding: 8px 12px;
          margin: 3px;
          background-color: #007bff;
          color: white;
          text-decoration: none;
          border-radius: 5px;
          text-align: center;
          font-size: 0.85rem;
      }
      
      /* Ajustes para las tarjetas de empleados */
      .empleado-card {
          margin-bottom: 10px;
      }
      
      .empleado-header {
          padding: 8px 12px;
          font-size: 0.9rem;
      }
      
      .empleado-registros {
          padding: 10px;
      }
      
      .registro-item {
          padding: 6px;
          margin-bottom: 3px;
          font-size: 0.85rem;
      }
      
      .registro-titulo {
          margin-bottom: 5px;
          padding-bottom: 3px;
          font-size: 0.9rem;
      }
      .link-button:hover {
          background-color: #0056b3;
      }
      .contenedor {
          display: flex;
          flex-direction: column;
          gap: 20px;
          margin-top: 20px;
          align-items: center;
      }
      .card, .registro {
          background-color: rgba(255, 255, 255, 0.8);
          padding: 20px;
          border-radius: 8px;
          width: 793px; /* Aumentado un 15% de 690px */
          max-width: 95%;
      }
      .registro {
          max-height: 575px; /* Aumentado un 15% de 500px */
          overflow-y: auto;
      }
      
      /* Estilos para los campos de texto */
      #employeeId, #employeeName {
          width: 70%; /* Reducido a√∫n m√°s (15% adicional del 85% anterior) */
          margin: 5px auto;
          padding: 8px;
          border-radius: 4px;
          border: 1px solid #ced4da;
          display: block; /* Para centrar con margin auto */
      }
      
      /* Estilos para las etiquetas */
      label {
          display: block;
          margin-top: 10px;
          text-align: center;
      }
      
      /* Estilos para los botones */
      .buttons {
          display: flex;
          justify-content: center;
          gap: 10px;
          margin-top: 15px;
      }
      
      .entrada, .salida {
          padding: 8px 15px;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-weight: bold;
      }
      
      .entrada {
          background-color: #28a745;
          color: white;
      }
      
      .salida {
          background-color: #dc3545;
          color: white;
      }
      
      .empleado-card {
          background-color: #f8f9fa;
          border-radius: 6px;
          margin-bottom: 15px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          overflow: hidden;
      }
      .empleado-header {
          background-color: #343a40;
          color: white;
          padding: 10px 15px;
          font-weight: bold;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      .empleado-registros {
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
          padding: 15px;
      }
      .registro-seccion {
          flex: 1;
          min-width: 250px;
      }
      .registro-titulo {
          font-weight: bold;
          margin-bottom: 8px;
          padding-bottom: 5px;
          border-bottom: 2px solid #dee2e6;
      }
      .registro-entrada .registro-titulo {
          color: #28a745;
          border-color: #28a745;
      }
      .registro-salida .registro-titulo {
          color: #dc3545;
          border-color: #dc3545;
      }
      .registro-item {
          padding: 8px;
          margin-bottom: 5px;
          border-radius: 4px;
          display: flex;
          justify-content: space-between;
      }
      .registro-entrada .registro-item {
          background-color: rgba(40, 167, 69, 0.1);
          border-left: 3px solid #28a745;
      }
      .registro-salida .registro-item {
          background-color: rgba(220, 53, 69, 0.1);
          border-left: 3px solid #dc3545;
      }
      .sin-registros {
          font-style: italic;
          color: #6c757d;
          padding: 8px;
      }
      .accion-icon {
          margin-right: 5px;
      }
      #toastContainer {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          z-index: 1000;
          width: 100%;
          display: flex;
          justify-content: center;
          pointer-events: none;
      }
      .toast {
          background-color: #333;
          color: white;
          padding: 15px 25px;
          margin-bottom: 10px;
          border-radius: 8px;
          opacity: 0.95;
          animation: fadeOut 2.5s forwards;
          font-size: 18px;
          font-weight: 500;
          box-shadow: 0 4px 8px rgba(0,0,0,0.2);
          max-width: 80%;
          text-align: center;
          pointer-events: auto;
      }
      .toast-error {
          background-color: #dc3545;
          animation: shake 0.5s, fadeOut 2.5s 0.5s forwards;
      }
      .toast-success {
          background-color: #28a745;
      }
      @keyframes fadeOut {
          0% { opacity: 0.9; }
          100% { opacity: 0; display: none; }
      }
      @keyframes shake {
          0%, 100% { transform: translateX(0); }
          10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
          20%, 40%, 60%, 80% { transform: translateX(5px); }
      }
      .empty-state {
          text-align: center;
          padding: 30px;
          color: #6c757d;
      }
      .empty-state p {
          margin-top: 10px;
          font-size: 14px;
      }
  </style>
</head>
<body>
  <h1>Registro de Empleados</h1>
  <div id="clock">--:--:--</div>

  <div class="contenedor">
    <div class="card">
      <label for="employeeId">ID del empleado:</label>
      <input type="text" id="employeeId" placeholder="Ej. 1234" />
      <label for="employeeName">Nombre del empleado:</label>
      <input type="text" id="employeeName" placeholder="Nombre aparecer√° autom√°ticamente" disabled />
      <div id="horarioInfo" style="text-align: center; margin-top: 5px; font-size: 0.9rem; color: #6c757d;"></div>

      <div class="buttons">
        <button class="entrada" onclick="registrar('Entrada')">Registrar Entrada</button>
        <button class="salida" onclick="registrar('Salida')">Registrar Salida</button>
      </div>
    </div>

    <div class="registro" id="registroContainer">
      <!-- Aqu√≠ se cargar√°n los registros agrupados por empleado -->
    </div>
    
    <div class="nav-buttons">
      <a href="usuarios.html" class="link-button">‚ûï Gestionar usuarios</a>
      <a href="reporte.html" class="link-button">üìä Ver reporte</a>
      <button class="link-button" style="background-color: #dc3545;" id="btnReinicio">üóëÔ∏è Reinicio</button>
    </div>
  </div>

  <div id="toastContainer"></div>

  <!-- Modal de autenticaci√≥n profesional -->
  <div id="authModal" class="modal-auth" style="display:none;">
    <div class="modal-auth-content">
      <h2>Autenticaci√≥n requerida</h2>
      <input type="text" id="authUser" placeholder="Usuario" autocomplete="username" />
      <input type="password" id="authPass" placeholder="Contrase√±a" autocomplete="current-password" />
      <div id="authError" class="auth-error"></div>
      <div class="modal-auth-actions">
        <button id="authAccept">Ingresar</button>
        <button id="authCancel">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>

  <!-- Configuraci√≥n de Firebase -->
  <script>
    // Configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBfDHo3vViwVMDfyPChyQyn0r4xih7O0jw",
      authDomain: "registro-horario-brimez.firebaseapp.com",
      projectId: "registro-horario-brimez",
      storageBucket: "registro-horario-brimez.firebasestorage.app",
      messagingSenderId: "1087754167148",
      appId: "1:1087754167148:web:db585aca2bb76c15ba4949",
      measurementId: "G-3S4NSSCGXW"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    firebase.analytics();
  </script>

  <script>
    setInterval(() => {
      const ahora = new Date();
      document.getElementById('clock').textContent = ahora.toLocaleTimeString('es-ES');
    }, 1000);

    let toastTimeout; // Variable global para controlar el timeout del toast

    function mostrarToast(mensaje, tipo = "success") {
      const toastContainer = document.getElementById("toastContainer");

      // Eliminar todos los toasts existentes antes de mostrar uno nuevo
      const oldToasts = toastContainer.querySelectorAll(".toast");
      oldToasts.forEach(t => t.remove());

      // Limpiar timeout anterior si existe
      if (toastTimeout) {
        clearTimeout(toastTimeout);
        toastTimeout = null;
      }

      // Crear el nuevo toast
      const toast = document.createElement("div");
      toast.className = "toast";
      if (tipo === "error") toast.classList.add("toast-error");
      if (tipo === "success") toast.classList.add("toast-success");
      toast.textContent = mensaje;
      toastContainer.appendChild(toast);

      // Forzar reinicio de animaci√≥n
      void toast.offsetWidth;

      // Eliminar el toast despu√©s de la animaci√≥n
      toastTimeout = setTimeout(() => {
        if (toast && toast.parentNode) {
          toast.remove();
        }
        toastTimeout = null;
      }, 3000);
    }

    document.getElementById("employeeId").addEventListener("input", () => {
      const id = document.getElementById("employeeId").value.trim();
      const nombreInput = document.getElementById("employeeName");
      
      if (id) {
        // Consultar en Firebase
        db.collection("empleados").doc(id).get()
          .then((doc) => {
            if (doc.exists) {
              const empleado = doc.data();
              nombreInput.value = empleado.nombre;
              
              // Mostrar informaci√≥n del horario si est√° disponible
              if (empleado.horarioEntrada && empleado.horarioSalida) {
                document.getElementById("horarioInfo").textContent = 
                  `Horario: ${empleado.horarioEntrada} - ${empleado.horarioSalida}`;
                if (empleado.comidaInicio && empleado.comidaFin) {
                  document.getElementById("horarioInfo").textContent += 
                    ` | Comida: ${empleado.comidaInicio} - ${empleado.comidaFin}`;
                }
              } else {
                document.getElementById("horarioInfo").textContent = "";
              }
            } else {
              nombreInput.value = "ID no registrado";
              document.getElementById("horarioInfo").textContent = "";
            }
          })
          .catch((error) => {
            console.error("Error al buscar empleado:", error);
            nombreInput.value = "Error al buscar";
            document.getElementById("horarioInfo").textContent = "";
          });
      } else {
        nombreInput.value = "";
        document.getElementById("horarioInfo").textContent = "";
      }
    });

    // Cargar registros al iniciar
    document.addEventListener("DOMContentLoaded", () => {
      cargarRegistrosHoy();
    });

    // Funci√≥n para reiniciar registros
    function reiniciarRegistros() {
      if (confirm("¬øEst√°s seguro de que deseas eliminar TODOS los registros? Esta acci√≥n no se puede deshacer.")) {
        // Mostrar mensaje de carga
        mostrarToast("Eliminando registros...", "info");
        
        // Obtener todos los registros
        db.collection("registros")
          .get()
          .then((snapshot) => {
            // Crear un batch para eliminar m√∫ltiples documentos
            const batch = db.batch();
            
            snapshot.forEach((doc) => {
              batch.delete(doc.ref);
            });
            
            // Ejecutar el batch
            return batch.commit();
          })
          .then(() => {
            mostrarToast("Todos los registros han sido eliminados", "success");
            cargarRegistrosHoy();
          })
          .catch((error) => {
            console.error("Error al eliminar registros:", error);
            mostrarToast("Error al eliminar registros", "error");
          });
      }
    }

    // Funci√≥n para cargar registros de hoy
    function cargarRegistrosHoy() {
      const container = document.getElementById("registroContainer");
      
      // Mostrar indicador de carga
      container.innerHTML = `
        <div class="empty-state">
          <p>Cargando registros...</p>
        </div>
      `;
      
      // Obtener fecha de hoy (inicio y fin)
      const hoy = new Date();
      const inicioHoy = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
      const finHoy = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate() + 1);
      
      // Consultar registros de hoy en Firebase
      db.collection("registros")
        .where("fechaCompleta", ">=", inicioHoy.toISOString())
        .where("fechaCompleta", "<", finHoy.toISOString())
        .orderBy("fechaCompleta", "desc")
        .get()
        .then((snapshot) => {
          if (snapshot.empty) {
            container.innerHTML = `
              <div class="empty-state">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="8" x2="12" y2="12"></line>
                  <line x1="12" y1="16" x2="12" y2="16"></line>
                </svg>
                <h3>No hay registros para hoy</h3>
                <p>Los registros de entrada y salida aparecer√°n aqu√≠.</p>
              </div>
            `;
            return;
          }
          
          // Limpiar contenedor
          container.innerHTML = '';
          
          // Agrupar registros por empleado
          const registrosPorEmpleado = {};
          
          snapshot.forEach(doc => {
            const registro = doc.data();
            const id = registro.id;
            
            if (!registrosPorEmpleado[id]) {
              registrosPorEmpleado[id] = {
                id: id,
                nombre: registro.nombre,
                entradas: [],
                salidas: []
              };
            }
            
            if (registro.tipo === "Entrada") {
              registrosPorEmpleado[id].entradas.push({
                hora: registro.hora,
                tiempoTrabajado: registro.tiempoTrabajado
              });
            } else if (registro.tipo === "Salida") {
              registrosPorEmpleado[id].salidas.push({
                hora: registro.hora
              });
            }
          });
          
          // Crear tarjetas para cada empleado
          Object.values(registrosPorEmpleado).forEach(empleado => {
            const empleadoCard = document.createElement("div");
            empleadoCard.className = "empleado-card";
            
            empleadoCard.innerHTML = `
              <div class="empleado-header">
                <span>${empleado.nombre} (ID: ${empleado.id})</span>
                <span>${hoy.toLocaleDateString('es-ES')}</span>
              </div>
              <div class="empleado-registros">
                <div class="registro-seccion registro-entrada">
                  <div class="registro-titulo">
                    <span class="accion-icon">‚¨áÔ∏è</span> Entradas (${empleado.entradas.length})
                  </div>
                  ${empleado.entradas.length > 0 ? 
                    empleado.entradas.map(entrada => `
                      <div class="registro-item">
                        <span>${entrada.hora}</span>
                        ${entrada.tiempoTrabajado ? `<span>Duraci√≥n: ${entrada.tiempoTrabajado}</span>` : ''}
                      </div>
                    `).join('') : 
                    '<div class="sin-registros">No hay registros de entrada</div>'
                  }
                </div>
                <div class="registro-seccion registro-salida">
                  <div class="registro-titulo">
                    <span class="accion-icon">‚¨ÜÔ∏è</span> Salidas (${empleado.salidas.length})
                  </div>
                  ${empleado.salidas.length > 0 ? 
                    empleado.salidas.map(salida => `
                      <div class="registro-item">
                        <span>${salida.hora}</span>
                      </div>
                    `).join('') : 
                    '<div class="sin-registros">No hay registros de salida</div>'
                  }
                </div>
              </div>
            `;
            
            container.appendChild(empleadoCard);
          });
        })
        .catch(error => {
          console.error("Error al cargar registros:", error);
          container.innerHTML = `
            <div class="empty-state">
              <h3>Error al cargar registros</h3>
              <p>${error.message}</p>
            </div>
          `;
        });
    }

    // Funci√≥n para guardar datos de empleado
    function guardarDatosEmpleado(id, nombre, horarioEntrada, horarioSalida) {
      // Obtener datos existentes
      let datosEmpleados = JSON.parse(localStorage.getItem('empleadosCompletos')) || {};
      
      // Actualizar o agregar datos del empleado
      datosEmpleados[id] = {
        id: id,
        nombre: nombre,
        horarioEntrada: horarioEntrada,
        horarioSalida: horarioSalida
      };
      
      // Guardar en localStorage
      localStorage.setItem('empleadosCompletos', JSON.stringify(datosEmpleados));
    }
    
    // Modificar la funci√≥n registrar para incluir validaciones y guardar datos del empleado
    function registrar(accion) {
      const id = document.getElementById("employeeId").value.trim();
      const nombre = document.getElementById("employeeName").value;
      
      if (!id) {
        mostrarToast("Por favor, ingresa el ID del empleado", "error");
        return;
      }
      
      if (nombre === "ID no registrado" || !nombre) {
        mostrarToast("Empleado no encontrado. Verifica el ID o reg√≠stralo primero", "error");
        return;
      }
      
      // Obtener fecha y hora actual
      const ahora = new Date();
      const fecha = ahora.toLocaleDateString('es-ES');
      const hora = ahora.toLocaleTimeString('es-ES');
      
      // Crear objeto de registro (CORRECTED: use 'tipo' instead of 'accion')
      const registro = {
        id: id,
        nombre: nombre,
        fecha: fecha,
        hora: hora,
        tipo: accion, // <-- THIS IS THE FIX
        fechaCompleta: ahora.toISOString()
      };
      
      // Guardar en Firebase
      db.collection("registros").add(registro)
        .then(() => {
          // Mostrar mensaje de √©xito
          mostrarToast(`${accion} registrada correctamente para ${nombre}`, "success");
          
          // Recargar registros
          cargarRegistrosHoy();
          
          // Limpiar campo de ID
          document.getElementById("employeeId").value = "";
          document.getElementById("employeeName").value = "";
          document.getElementById("horarioInfo").textContent = "";
        })
        .catch((error) => {
          console.error("Error al guardar registro:", error);
          mostrarToast("Error al guardar registro. Intenta nuevamente.", "error");
        });
    }

    // Funci√≥n para registrar entrada o salida
    function registrar(tipo) {
      const id = document.getElementById("employeeId").value.trim();
      const nombre = document.getElementById("employeeName").value.trim();

      if (!id || nombre === "ID no registrado" || nombre === "Error al buscar") {
        mostrarToast("¬°ID no v√°lido! Verifique e intente de nuevo.", "error");
        return;
      }

      // Buscar la √∫ltima entrada del usuario SIN salida registrada en Firebase
      db.collection("registros")
        .where("id", "==", id)
        .where("tipo", "==", "Entrada")
        .where("tiempoTrabajado", "==", null)
        .orderBy("fechaCompleta", "desc")
        .limit(1)
        .get()
        .then((snapshot) => {
          let ultimoRegistro = null;
          if (!snapshot.empty) {
            const doc = snapshot.docs[0];
            ultimoRegistro = {
              docId: doc.id,
              ...doc.data()
            };
          }
          
          if (tipo === "Entrada" && ultimoRegistro) {
            mostrarToast("Ya existe una entrada activa sin salida registrada.", "error");
            return;
          }

          if (tipo === "Salida" && !ultimoRegistro) {
            mostrarToast("No se ha registrado una entrada previa.", "error");
            return;
          }

          const ahora = new Date();
          const hora = ahora.toLocaleTimeString('es-ES');
          const fecha = ahora.toLocaleDateString('es-ES');
          const fechaCompleta = ahora.toISOString();

          // Crear nuevo registro
          const nuevoRegistro = { 
            id, 
            nombre, 
            tipo, 
            hora, 
            fecha,
            fechaCompleta,
            tiempoTrabajado: null
          };

          if (tipo === "Salida" && ultimoRegistro) {
            const horaEntrada = new Date(ultimoRegistro.fechaCompleta);
            const diferenciaMs = ahora - horaEntrada;
            const minutos = Math.floor(diferenciaMs / 60000);
            const horas = Math.floor(minutos / 60);
            const minutosRestantes = minutos % 60;
            const tiempoTrabajado = `${horas}h ${minutosRestantes}m`;

            // Actualizar el registro de entrada con el tiempo trabajado
            db.collection("registros").doc(ultimoRegistro.docId).update({
              tiempoTrabajado: tiempoTrabajado
            })
            .then(() => {
              mostrarToast(`Salida registrada. Tiempo trabajado: ${tiempoTrabajado}`, "success");
              
              // Guardar el registro de salida
              db.collection("registros").add(nuevoRegistro)
                .then(() => {
                  // Limpiar campos y recargar registros
                  document.getElementById("employeeId").value = "";
                  document.getElementById("employeeName").value = "";
                  document.getElementById("horarioInfo").textContent = "";
                  cargarRegistrosHoy();
                })
                .catch(error => {
                  console.error("Error al guardar registro de salida:", error);
                  mostrarToast("Error al guardar registro. Intente nuevamente.", "error");
                });
            })
            .catch(error => {
              console.error("Error al actualizar registro de entrada:", error);
              mostrarToast("Error al procesar la solicitud. Intente nuevamente.", "error");
            });
          } else {
            // Es una entrada, simplemente guardarla
            db.collection("registros").add(nuevoRegistro)
              .then(() => {
                mostrarToast(`Entrada registrada a las ${hora}`, "success");
                // Limpiar campos y recargar registros
                document.getElementById("employeeId").value = "";
                document.getElementById("employeeName").value = "";
                document.getElementById("horarioInfo").textContent = "";
                cargarRegistrosHoy();
              })
              .catch(error => {
                console.error("Error al guardar registro:", error);
                mostrarToast("Error al guardar registro. Intente nuevamente.", "error");
              });
          }
        })
        .catch((error) => {
          console.error("Error al verificar registros:", error);
          mostrarToast("Error al procesar la solicitud. Intente nuevamente.", "error");
        });
    }

    // Funci√≥n para cargar los registros del d√≠a actual
    function cargarRegistrosHoy() {
      const hoy = new Date().toLocaleDateString('es-ES');
      const registroContainer = document.getElementById("registroContainer");
      
      // Mostrar indicador de carga
      registroContainer.innerHTML = '<div class="empty-state">Cargando registros...</div>';
      
      // Consultar registros de hoy en Firebase
      const inicioHoy = new Date();
      inicioHoy.setHours(0, 0, 0, 0);
      
      db.collection("registros")
        .where("fechaCompleta", ">=", inicioHoy.toISOString())
        .orderBy("fechaCompleta", "desc")
        .get()
        .then((snapshot) => {
          if (snapshot.empty) {
            registroContainer.innerHTML = '<div class="empty-state"><h3>No hay registros para hoy</h3><p>Los registros aparecer√°n aqu√≠ cuando se realicen.</p></div>';
            return;
          }
          
          // Agrupar registros por empleado
          const registrosPorEmpleado = {};
          
          snapshot.forEach(doc => {
            const registro = doc.data();
            const id = registro.id;
            
            if (!registrosPorEmpleado[id]) {
              registrosPorEmpleado[id] = {
                id: id,
                nombre: registro.nombre,
                entradas: [],
                salidas: []
              };
            }
            
            if (registro.tipo === "Entrada") {
              registrosPorEmpleado[id].entradas.push({
                hora: registro.hora,
                tiempoTrabajado: registro.tiempoTrabajado
              });
            } else {
              registrosPorEmpleado[id].salidas.push({
                hora: registro.hora
              });
            }
          });
          
          // Generar HTML para cada empleado
          registroContainer.innerHTML = '';
          
          Object.values(registrosPorEmpleado).forEach(empleado => {
            const empleadoCard = document.createElement("div");
            empleadoCard.className = "empleado-card";
            
            empleadoCard.innerHTML = `
              <div class="empleado-header">
                <span>${empleado.nombre} (ID: ${empleado.id})</span>
                <span>${hoy}</span>
              </div>
              <div class="empleado-registros">
                <div class="registro-seccion registro-entrada">
                  <div class="registro-titulo">
                    <span class="accion-icon">‚¨áÔ∏è</span> Entradas (${empleado.entradas.length})
                  </div>
                  ${empleado.entradas.length > 0 ? 
                    empleado.entradas.map(entrada => `
                      <div class="registro-item">
                        <span>${entrada.hora}</span>
                        ${entrada.tiempoTrabajado ? `<span>Duraci√≥n: ${entrada.tiempoTrabajado}</span>` : ''}
                      </div>
                    `).join('') : 
                    '<div class="sin-registros">No hay registros de entrada</div>'
                  }
                </div>
                <div class="registro-seccion registro-salida">
                  <div class="registro-titulo">
                    <span class="accion-icon">‚¨ÜÔ∏è</span> Salidas (${empleado.salidas.length})
                  </div>
                  ${empleado.salidas.length > 0 ? 
                    empleado.salidas.map(salida => `
                      <div class="registro-item">
                        <span>${salida.hora}</span>
                      </div>
                    `).join('') : 
                    '<div class="sin-registros">No hay registros de salida</div>'
                  }
                </div>
              </div>
            `;
            
            registroContainer.appendChild(empleadoCard);
          });
        })
        .catch(error => {
          console.error("Error al cargar registros:", error);
          registroContainer.innerHTML = `<div class="empty-state"><h3>Error al cargar registros</h3><p>${error.message}</p></div>`;
        });
    }

    // Cargar registros al iniciar
    document.addEventListener("DOMContentLoaded", () => {
      cargarRegistrosHoy();
    });
  </script>

  <!-- Scripts -->
  <script src="app.js"></script>
  <script src="script.js"></script>
  <script src="registros_diarios.js"></script>

  <script>
// --- Modal de autenticaci√≥n profesional ---
let accionPendiente = null;
function mostrarAuthModal(callbackExitoso) {
  accionPendiente = callbackExitoso;
  document.getElementById('authUser').value = '';
  document.getElementById('authPass').value = '';
  document.getElementById('authError').textContent = '';
  document.getElementById('authModal').style.display = 'flex';
  document.getElementById('authUser').focus();
}
function cerrarAuthModal() {
  document.getElementById('authModal').style.display = 'none';
}
function verificarCredenciales() {
  const usuario = document.getElementById('authUser').value.trim();
  const contrasena = document.getElementById('authPass').value;
  if (usuario !== 'brimezadmin') {
    document.getElementById('authError').textContent = 'Usuario incorrecto.';
    return;
  }
  if (contrasena !== 'brimez1') {
    document.getElementById('authError').textContent = 'Contrase√±a incorrecta.';
    return;
  }
  cerrarAuthModal();
  if (typeof accionPendiente === 'function') accionPendiente();
}
document.getElementById('authAccept').onclick = verificarCredenciales;
document.getElementById('authCancel').onclick = cerrarAuthModal;
document.getElementById('authPass').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') verificarCredenciales();
});
document.getElementById('authUser').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') document.getElementById('authPass').focus();
});
// Dentro del bloque de autenticaci√≥n profesional
function flujoReinicioSeguro() {
  mostrarAuthModal(() => {
    if (confirm('¬øEst√° seguro de reiniciar todos los registros? Esta acci√≥n no se puede deshacer.')) {
      reiniciarRegistros();
    }
  });
}

document.addEventListener('DOMContentLoaded', () => {
  const btnUsuarios = document.querySelector('a[href="usuarios.html"]');
  if (btnUsuarios) {
    btnUsuarios.addEventListener('click', function(e) {
      e.preventDefault();
      mostrarAuthModal(() => {
        window.location.href = 'usuarios.html';
      });
    });
  }
  const btnReporte = document.querySelector('a[href="reporte.html"]');
  if (btnReporte) {
    btnReporte.addEventListener('click', function(e) {
      e.preventDefault();
      mostrarAuthModal(() => {
        window.location.href = 'reporte.html';
      });
    });
  }
  const btnReinicio = document.getElementById('btnReinicio');
  if (btnReinicio) {
    btnReinicio.addEventListener('click', function(e) {
      e.preventDefault();
      flujoReinicioSeguro();
    });
  }
});
</script>
</body>
</html>